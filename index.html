<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>LAAT25 Lintuharjoitus</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      position: relative;
      overflow: hidden;
    }
    img {
      width: 500px;
      height: auto;
      border: 2px solid #000;
      margin-bottom: 20px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 20px;
    }
    #instruction, #result, #score, #finalScore {
      margin-top: 20px;
      font-size: 20px;
    }
    #instruction {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
    #finalScore {
      margin-top: 40px;
      font-size: 24px;
      font-weight: bold;
    }
    #backgroundMessage {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 200px;
      color: red;
      opacity: 0;
      z-index: 0;
      transition: opacity 0.5s ease-in-out;
      pointer-events: none;
    }
    body.show-background #backgroundMessage {
      opacity: 0.2;
    }
    #options {
      display: none;
    }
  </style>
</head>
<body>
  <h1>LAAT25 Lintuharjoitus</h1>
  <div id="backgroundMessage">OIKEIN!</div>
  <img id="birdImage" src="" alt="Linnun kuva">
  <p id="instruction" onclick="showOptions()">Klikkaa tästä näyttääksesi vaihtoehdot (0,5 pistettä)</p>
  <div id="options">
    <button onclick="checkAnswer(0)"></button>
    <button onclick="checkAnswer(1)"></button>
    <button onclick="checkAnswer(2)"></button>
  </div>
  <p id="result"></p>
  <p id="score"></p>
  <p id="finalScore">Pisteitä: 0</p>

  <script>
    const birdsByCategory = {
      "Vesilinnut": ["haapana", "isokoskelo", "jouhisorsa", "kaakkuri", "kuikka", "laulujoutsen", "merihanhi", "metsähanhi", "pilkkasiipi", "härkälintu", "sinisorsa", "tavi", "telkkä", "tukkakoskelo", "tukkasotka", "uivelo"],
      "Kahlaajat": ["isokuovi", "kapustarinta", "liro", "rantasipi", "suokukko", "valkoviklo", "taivaanvuohi", "töyhtöhyyppä", "kurki"],
      "Päivänpetolinnut": ["kalasääski", "kanahaukka", "maakotka", "merikotka", "muuttohaukka"],
      "Kanalinnut": ["pyy", "metso", "teeri", "riekko", "fasaani"],
      "Pöllöt": ["helmipöllö", "lapinpöllö", "suopöllö", "hiiripöllö", "varpuspöllö", "huuhkaja"],
      "Tikat/käki/sepelkyyhky": ["palokärki", "pohjantikka", "käpytikka", "käki", "sepelkyyhky"],
      "Lokit/Tiirat": ["kalalokki", "harmaalokki", "naurulokki", "pikkulokki", "selkälokki", "kalatiira"],
      "Varislinnut": ["varis", "korppi", "harakka", "närhi", "kuukkeli"],
      "Rastaat": ["mustarastas", "räkättirastas", "laulurastas", "punakylkirastas"],
      "Tiaiset": ["sinitiainen", "hömötiainen", "talitiainen", "töyhtötiainen"],
      "Pääskyt/kirskulinnut": ["haarapääsky", "törmäpääsky", "räystäspääsky", "tervapääsky"],
      "Muut pikkulinnut": ["järripeippo", "peippo", "viherpeippo", "keltasirkku", "kirjosieppo", "koskikara", "leppälintu", "pajulintu", "pulmunen", "punatulkku", "urpiainen", "tilhi", "varpunen", "västäräkki"],
      "Käpylinnut": ["isokäpylintu"]
    };

    const birdNameMappings = {
      "pilkkasiipi": "Mergus serrator",
      "metso": "Tetrao urogallus",
      "isokuovi": "Numenius arquata",
      "harakka": "Pica pica"
    };

    let currentBird, correctAnswerIndex, score = 0, questionCount = 0, optionsShown = false;

    function getRandomBird() {
      const category = Object.keys(birdsByCategory)[Math.floor(Math.random() * Object.keys(birdsByCategory).length)];
      const bird = birdsByCategory[category][Math.floor(Math.random() * birdsByCategory[category].length)];
      return { category, bird };
    }

    function getRandomOptions(correctBird, category) {
      const options = [correctBird];
      const birds = birdsByCategory[category];
      while (options.length < 3 && birds.length > 1) {
        const bird = birds[Math.floor(Math.random() * birds.length)];
        if (!options.includes(bird)) options.push(bird);
      }

      const allBirds = Object.values(birdsByCategory).flat();
      while (options.length < 3) {
        const bird = allBirds[Math.floor(Math.random() * allBirds.length)];
        if (!options.includes(bird)) options.push(bird);
      }

      return options.sort(() => Math.random() - 0.5);
    }

    async function fetchWikimediaImage(birdName) {
      const searchTerm = birdNameMappings[birdName] || birdName;
      const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages&pithumbsize=500&titles=${encodeURIComponent(searchTerm)}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const page = Object.values(data.query.pages)[0];
        return page?.thumbnail?.source || null;
      } catch { return null; }
    }

    async function findBirdImage(birdName) {
      if (birdName === "harakka") return "https://upload.wikimedia.org/wikipedia/commons/4/42/Sroka_Pica_Pica_II.jpg";
      if (birdName === "pilkkasiipi") return "https://suomenluonto.fi/wp-content/uploads/2022/06/pilkkasiipi_anne_keskiviikka-1600x991.jpeg";

      const image = await fetchWikimediaImage(birdName);
      return image || "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";
    }

    async function loadQuiz() {
      const { category, bird } = getRandomBird();
      currentBird = bird;
      const options = getRandomOptions(bird, category);
      correctAnswerIndex = options.indexOf(bird);

      const imageUrl = await findBirdImage(bird);
      document.getElementById('birdImage').src = imageUrl;

      const buttons = document.getElementById('options').children;
      for (let i = 0; i < 3; i++) {
        buttons[i].textContent = options[i];
      }

      document.getElementById('result').textContent = '';
      document.getElementById('score').textContent = `Kysymys ${questionCount + 1}`;
      document.getElementById('options').style.display = 'none';
      document.body.classList.remove('show-background');
      optionsShown = false;
    }

    function showOptions() {
      document.getElementById('options').style.display = 'block';
      optionsShown = true;
    }

    function checkAnswer(selectedIndex) {
      const chosen = document.getElementById('options').children[selectedIndex].textContent;
      if (chosen === currentBird) {
        document.body.classList.add('show-background');
        document.getElementById('result').textContent = '';
        score += optionsShown ? 0.5 : 1;
      } else {
        document.body.classList.remove('show-background');
        document.getElementById('result').textContent = `Väärin! Oikea vastaus oli: ${currentBird}`;
      }

      questionCount++;
      updateScore();
      setTimeout(loadQuiz, 3000);
    }

    function updateScore() {
      document.getElementById('finalScore').textContent = `Pisteitä: ${score}`;
    }

    window.onload = loadQuiz;
  </script>
</body>
</html>
