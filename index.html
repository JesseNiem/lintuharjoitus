<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAAT25 Lintuharjoitus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 30px;
            background-color: #222;
            color: white;
        }

        img {
            width: 500px;
            height: auto;
            border: 2px solid #fff;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .reveal-button {
            color: #00ff00;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        button {
            margin: 10px;
            padding: 10px;
            font-size: 20px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 18px;
            margin-top: 20px;
        }

        #pointsDisplay {
            margin-top: 20px;
            font-size: 22px;
            font-weight: bold;
        }

        #questionCount {
            font-size: 20px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>LAAT25 Lintuharjoitus</h1>
    <div id="questionCount"></div>
    <div id="quiz">
        <img id="birdImage" src="" alt="Linnun kuva">
        <div id="reveal" class="reveal-button" onclick="revealOptions()">näytä vaihtoehdot (-0,5)</div>
        <div id="options" class="hidden">
            <button onclick="checkAnswer(0)"></button>
            <button onclick="checkAnswer(1)"></button>
            <button onclick="checkAnswer(2)"></button>
        </div>
        <div>
            <input type="text" id="textAnswer" placeholder="Kirjoita linnun nimi ja paina enter" onkeydown="handleTextInput(event)">
        </div>
        <p id="result"></p>
        <div id="pointsDisplay">Pisteet: 0</div>
    </div>

    <script>
        const birdsByCategory = {
            "Vesilinnut": ["haapana", "isokoskelo", "jouhisorsa", "kaakkuri", "kuikka", "laulujoutsen", "merihanhi", "metsähanhi", "pilkkasiipi", "härkälintu", "sinisorsa", "tavi", "telkkä", "tukkakoskelo", "tukkasotka", "uivelo"],
            "Kahlaajat": ["isokuovi", "kapustarinta", "liro", "rantasipi", "suokukko", "valkoviklo", "taivaanvuohi", "töyhtöhyyppä", "kurki"],
            "Päivänpetolinnut": ["kalasääski", "kanahaukka", "maakotka", "merikotka", "muuttohaukka"],
            "Kanalinnut": ["pyy", "metso", "teeri", "riekko", "fasaani"],
            "Pöllöt": ["helmipöllö", "lapinpöllö", "suopöllö", "hiiripöllö", "varpuspöllö", "huuhkaja"],
            "Tikat/käki/sepelkyyhky": ["palokärki", "pohjantikka", "käpytikka", "käki", "sepelkyyhky"],
            "Lokit/Tiirat": ["kalalokki", "harmaalokki", "naurulokki", "pikkulokki", "selkälokki", "kalatiira"],
            "Varislinnut": ["varis", "korppi", "harakka", "närhi", "kuukkeli"],
            "Rastaat": ["mustarastas", "räkättirastas", "laulurastas", "punakylkirastas"],
            "Tiaiset": ["sinitiainen", "hömötiainen", "talitiainen", "töyhtötiainen"],
            "Pääskyt/kirskulinnut": ["haarapääsky", "törmäpääsky", "räystäspääsky", "tervapääsky"],
            "Muut pikkulinnut": ["järripeippo", "peippo", "viherpeippo", "keltasirkku", "kirjosieppo", "koskikara", "leppälintu", "pajulintu", "pulmunen", "punatulkku", "urpiainen", "tilhi", "varpunen", "västäräkki"],
            "Käpylinnut": ["isokäpylintu"]
        };

        const birdNameMappings = {
            "pilkkasiipi": "Mergus serrator",
            "metso": "Tetrao urogallus",
            "isokuovi": "Numenius arquata",
            "harakka": "Pica pica"
        };

        let allBirds = Object.entries(birdsByCategory).flatMap(([_, birds]) => birds);
        let currentBirdIndex = 0;
        let score = 0;
        let optionsRevealed = false;
        let quizOrder = [...allBirds].sort(() => Math.random() - 0.5);
        let correctAnswerIndex;

        async function fetchImage(birdName) {
            if (birdName === "harakka") {
                return "https://upload.wikimedia.org/wikipedia/commons/4/42/Sroka_Pica_Pica_II.jpg";
            }
            if (birdName === "pilkkasiipi") {
                return "https://suomenluonto.fi/wp-content/uploads/2022/06/pilkkasiipi_anne_keskiviikka-1600x991.jpeg";
            }

            const searchTerm = birdNameMappings[birdName] || birdName;
            try {
                const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages&pithumbsize=500&titles=${encodeURIComponent(searchTerm)}`);
                const data = await res.json();
                const page = Object.values(data.query.pages)[0];
                return page?.thumbnail?.source || null;
            } catch {
                return "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";
            }
        }

        async function loadQuiz() {
            document.getElementById('result').textContent = '';
            document.getElementById('textAnswer').value = '';
            document.getElementById('options').classList.add('hidden');
            document.getElementById('reveal').classList.remove('hidden');
            optionsRevealed = false;

            if (currentBirdIndex >= quizOrder.length) {
                document.getElementById('quiz').innerHTML = "<h2>Harjoitus suoritettu!</h2><div id='pointsDisplay'>Pisteet: " + score + "</div>";
                return;
            }

            const bird = quizOrder[currentBirdIndex];
            const category = Object.entries(birdsByCategory).find(([_, birds]) => birds.includes(bird))[0];

            const options = getOptions(bird, category);
            correctAnswerIndex = options.indexOf(bird);

            const imageUrl = await fetchImage(bird);
            document.getElementById('birdImage').src = imageUrl;

            const buttons = document.getElementById('options').children;
            options.forEach((opt, i) => buttons[i].textContent = opt);

            document.getElementById('questionCount').textContent = `Kysymys ${currentBirdIndex + 1} / ${quizOrder.length}`;
        }

        function getOptions(correctBird, category) {
            const options = [correctBird];
            const categoryBirds = birdsByCategory[category];
            while (options.length < 3 && categoryBirds.length > 1) {
                const randBird = categoryBirds[Math.floor(Math.random() * categoryBirds.length)];
                if (!options.includes(randBird)) options.push(randBird);
            }
            if (options.length < 3) {
                while (options.length < 3) {
                    const randBird = allBirds[Math.floor(Math.random() * allBirds.length)];
                    if (!options.includes(randBird)) options.push(randBird);
                }
            }
            return options.sort(() => Math.random() - 0.5);
        }

        function revealOptions() {
            optionsRevealed = true;
            document.getElementById('options').classList.remove('hidden');
            document.getElementById('reveal').classList.add('hidden');
        }

        function checkAnswer(index) {
            if (index === correctAnswerIndex) {
                score += 0.5;
                document.getElementById('result').textContent = "Oikein! (+0,5)";
            } else {
                document.getElementById('result').textContent = "Väärin!";
            }
            updateScore();
            currentBirdIndex++;
            setTimeout(loadQuiz, 1500);
        }

        function handleTextInput(event) {
            if (event.key === "Enter") {
                const guess = event.target.value.trim().toLowerCase();
                const correct = quizOrder[currentBirdIndex].toLowerCase();
                if (guess === correct) {
                    score += 1;
                    document.getElementById('result').textContent = "Oikein! (+1)";
                } else {
                    document.getElementById('result').textContent = "Väärin!";
                }
                updateScore();
                currentBirdIndex++;
                setTimeout(loadQuiz, 1500);
            }
        }

        function updateScore() {
            document.getElementById('pointsDisplay').textContent = `Pisteet: ${score}`;
        }

        window.onload = loadQuiz;
    </script>
</body>
</html>
